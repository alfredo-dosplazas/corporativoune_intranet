{% load money %}
{% load humanize %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}

<form id="requisicion-form" method="post" novalidate>
    {% csrf_token %}

    <!-- ===================== -->
    <!-- FORM PRINCIPAL -->
    <!-- ===================== -->
    <div class="card bg-base-100 shadow mb-4">
        <div class="card-body">
            {% crispy form %}
        </div>
    </div>

    <!-- ===================== -->
    <!-- DETALLE / INLINE FORMSET -->
    <!-- ===================== -->
    <div class="card bg-base-100 shadow">
        <div class="card-body space-y-3">

            {% if Detalle.non_form_errors %}
                <div class="alert alert-error text-sm">
                    <ul class="list-disc pl-5">
                        {% for error in Detalle.non_form_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {{ Detalle.management_form }}

            <!-- TEMPLATE VACÍO -->
            <div id="empty_row" class="hidden">
                <table>
                    <tbody>
                    <tr class="form-row hover">
                        <td>
                            {{ Detalle.empty_form.id }}
                            {{ Detalle.empty_form.articulo|as_crispy_field }}

                            <div class="link-articulo hidden text-xs mt-1">
                                <a target="_blank" class="link link-primary">Ver</a>
                            </div>
                        </td>
                        <td>{{ Detalle.empty_form.cantidad|as_crispy_field }}</td>
                        <td>{{ Detalle.empty_form.notas|as_crispy_field }}</td>
                        <td class="precio text-right">-</td>
                        <td class="impuesto text-right">-</td>
                        <td class="importe text-right">-</td>
                        <td class="subtotal text-right font-medium">-</td>

                        {% if perms.papeleria.delete_detallerequisicion %}
                            <td class="text-center align-middle">
                                {{ Detalle.empty_form.DELETE|as_crispy_field }}
                            </td>
                        {% endif %}
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- TABLA -->
            <div class="overflow-x-auto relative">
                <table
                        id="table-detalle"
                        class="formset table table-sm table-zebra w-full text-sm"
                >
                    <thead class="sticky top-0 bg-base-200 z-10">
                    <tr>
                        <th>Artículo</th>
                        <th class="w-24">Cant.</th>
                        <th>Notas</th>
                        <th class="text-right">Precio</th>
                        <th class="text-right">Imp.</th>
                        <th class="text-right">Importe</th>
                        <th class="text-right">Subtotal</th>
                        {% if perms.papeleria.delete_detallerequisicion %}
                            <th class="text-center w-16">✕</th>
                        {% endif %}
                    </tr>
                    </thead>

                    <tbody>
                    {% for inline_form in Detalle %}
                        <tr
                                class="form-row hover
                            {% if inline_form.errors %}bg-error/10 border-l-4 border-error{% endif %}"
                        >
                            <td>
                                {{ inline_form.id }}

                                <div class="space-y-1">
                                    {{ inline_form.articulo|as_crispy_field }}

                                    {% if inline_form.non_field_errors %}
                                        <div class="text-error text-xs">
                                            {% for error in inline_form.non_field_errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    <div
                                            class="link-articulo text-xs
                                        {% if not inline_form.instance.articulo %}hidden{% endif %}"
                                    >
                                        <a
                                                target="_blank"
                                                href="{{ inline_form.instance.articulo.get_absolute_url }}"
                                                class="link link-primary"
                                        >
                                            Ver artículo
                                        </a>
                                    </div>
                                </div>
                            </td>

                            <td>{{ inline_form.cantidad|as_crispy_field }}</td>
                            <td>{{ inline_form.notas|as_crispy_field }}</td>

                            <td class="precio text-right">
                                {{ inline_form.instance.articulo.precio|money|default:"-" }}
                            </td>
                            <td class="impuesto text-right">
                                {{ inline_form.instance.articulo.impuesto|percent|default:"-" }}
                            </td>
                            <td class="importe text-right">
                                {{ inline_form.instance.articulo.importe|money|default:"-" }}
                            </td>
                            <td class="subtotal text-right font-medium">
                                {{ inline_form.instance.subtotal|money|default:"-" }}
                            </td>

                            {% if perms.papeleria.delete_detallerequisicion %}
                                <td class="text-center align-middle">
                                    {{ inline_form.DELETE|as_crispy_field }}
                                </td>
                            {% endif %}
                        </tr>
                    {% endfor %}

                    </tbody>

                    <!-- TOTAL STICKY -->
                    <tfoot class="sticky bottom-0 bg-base-200 font-semibold">
                    <tr>
                        <th colspan="5"></th>
                        <th class="text-right">Total</th>
                        <th id="total-general" class="text-right">
                            {% if form.instance.pk %}
                                {{ form.instance.total|money }}
                            {% else %}
                                0.00
                            {% endif %}
                        </th>
                        {% if perms.papeleria.delete_detallerequisicion %}
                            <th></th>
                        {% endif %}
                    </tr>
                    </tfoot>
                </table>

                <div class="flex justify-start w-full bg-base-100 p-4 border border-base-300">
                    <button
                            type="button"
                            id="add-form"
                            class="link link-success mt-4"
                    >
                        + Agregar artículo
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>


<script>
    $(function () {
        let formIdx = {{ Detalle.total_form_count }};

        $("#add-form").click(function () {
            const $totalForms = $("#id_detalle_requisicion-TOTAL_FORMS");
            let totalForms = parseInt($totalForms.val());

            const template = $("#empty_row tbody").html();
            const rowHtml = template.replace(/__prefix__/g, totalForms);
            const $row = $(rowHtml);

            $totalForms.val(totalForms + 1);
            $("#table-detalle tbody").append($row);

            // Feedback UX
            $row[0].scrollIntoView({behavior: "smooth", block: "center"});
            $row.addClass("bg-success/10");

            setTimeout(() => {
                $row.removeClass("bg-success/10");
            }, 1500);
        });

    });
</script>

<script>
    function actualizarFila($select) {
        const row = $select.closest("tr");
        const data = $select.select2("data")[0] || {};

        const precio = parseFloat(data.precio) || 0;
        const impuesto = parseFloat(data.impuesto) || 0;

        const cantidad = parseFloat(
            row.find("input[name$='cantidad']").val()
        ) || 1;

        const importe = cantidad * precio;
        const subtotal = importe * (1 + impuesto);

        row.find(".precio").text(precio.toFixed(2));
        row.find(".impuesto").text((impuesto * 100).toFixed(0) + "%");
        row.find(".importe").text(importe.toFixed(2));
        row.find(".subtotal").text(subtotal.toFixed(2));

        if (data.url) {
            row.find(".link-articulo")
                .removeClass("hidden");
            row.find(".link-articulo a")
                .attr("href", data.url);
        } else {
            row.find(".link-articulo")
                .addClass("hidden");
        }

        recalcularTotal();
    }
</script>

<script>
    function recalcularTotal() {
        let total = 0;

        $("#table-detalle tbody tr").each(function () {
            const subtotal = parseFloat(
                $(this).find(".subtotal").text()
            ) || 0;
            total += subtotal;
        });

        $("#table-detalle tfoot th:last")
            .text(total.toFixed(2));
    }
</script>


<script>
    $("#table-detalle").on(
        "select2:select select2:clear",
        '[data-autocomplete-light-function="select2"]',
        function () {
            actualizarFila($(this));
        }
    );

    $("#table-detalle").on(
        "input",
        "input[name$='cantidad']",
        function () {
            const row = $(this).closest("tr");
            const select = row.find('[data-autocomplete-light-function="select2"]');
            if (select.val()) {
                actualizarFila(select);
            }
        }
    );
</script>