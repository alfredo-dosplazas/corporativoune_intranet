{% load crispy_forms_filters %}
{% load crispy_forms_tags %}

<div class="card bg-base-100 shadow-xl border border-base-300">
    <div class="card-body gap-6">
        {% if form.errors or Trabajo.errors %}
            <div id="form-errors-banner" class="alert alert-error alert-soft mb-6">
                <div>
                    <h3 class="font-bold">
                        No se pudo guardar la estructura.
                    </h3>
                    <p class="text-sm opacity-90">
                        Hay errores en el formulario. Revisa los campos marcados en rojo.
                    </p>
                </div>
            </div>
        {% endif %}

        <form id="estructura-form" method="post" class="space-y-8">
            {% csrf_token %}

            <div>
                <div class="divider divider-start font-semibold">
                    Datos de la estructura
                </div>

                {% crispy form %}
            </div>

            <div>
                <div class="divider divider-start font-semibold">
                    Trabajos de la estructura
                </div>

                <div class="flex gap-3 mb-4">
                    <input
                            type="text"
                            placeholder="Buscar por clave o nombre..."
                            class="input input-sm input-bordered w-full"
                            data-filter-input
                    >

                    <select
                            class="select select-sm select-bordered"
                            data-filter-paquete
                    >
                        <option value="">Todos los paquetes</option>
                        {% for paquete in paquetes %}
                            <option value="{{ paquete.id }}">
                                {{ paquete.clave }} - {{ paquete.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                {{ Trabajo.management_form }}

                <div class="max-h-[60vh] overflow-y-auto pr-2 space-y-4">

                    {% for paquete in paquetes %}
                        <div
                                class="collapse collapse-arrow border border-base-300 rounded-lg"
                                data-paquete="{{ paquete.id }}"
                        >
                            <input type="checkbox"/>

                            <div class="collapse-title font-semibold">
                                {{ paquete.clave }} — {{ paquete.nombre }}
                            </div>

                            <div class="collapse-content">

                                <table class="table table-sm">
                                    <thead>
                                    <tr>
                                        <th class="w-8"></th>
                                        <th>Clave</th>
                                        <th>Trabajo</th>
                                        <th>Unidad</th>
                                        <th class="w-32">Cantidad base</th>
                                    </tr>
                                    </thead>
                                    <tbody>

                                    {% for trabajo in paquete.trabajos.all %}
                                        {% with trabajos_seleccionados|get_item:trabajo.id as cantidad %}
                                            <tr data-trabajo-row>
                                                <td>
                                                    <input
                                                            type="checkbox"
                                                            name="trabajos"
                                                            value="{{ trabajo.id }}"
                                                            class="checkbox checkbox-sm"
                                                            {% if cantidad %}checked{% endif %}
                                                    >
                                                </td>

                                                <td class="font-mono text-xs">
                                                    {{ trabajo.clave }}
                                                </td>

                                                <td>
                                                    {{ trabajo.nombre }}
                                                </td>

                                                <td class="text-xs opacity-70">
                                                    {{ trabajo.unidad }}
                                                </td>

                                                <td>
                                                    <input
                                                            type="number"
                                                            step="0.01"
                                                            min="0"
                                                            name="cantidad_{{ trabajo.id }}"
                                                            class="input input-xs input-bordered w-full"
                                                            value="{{ cantidad|default:1 }}"
                                                            {% if not cantidad %}disabled{% endif %}
                                                    >
                                                </td>
                                            </tr>
                                        {% endwith %}
                                    {% endfor %}

                                    </tbody>
                                </table>

                            </div>
                        </div>
                    {% endfor %}
                </div>

            </div>

        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {

        // Checkbox → cantidad
        document.querySelectorAll('input[type="checkbox"][name="trabajos"]').forEach(cb => {
            cb.addEventListener("change", e => {
                const row = e.target.closest("tr")
                const qty = row.querySelector('input[type="number"]')
                qty.disabled = !e.target.checked
            })
        })

        // Filtro texto
        const textInput = document.querySelector("[data-filter-input]")
        const rows = document.querySelectorAll("[data-trabajo-row]")

        textInput.addEventListener("input", e => {
            const q = e.target.value.toLowerCase()
            rows.forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(q)
                    ? ""
                    : "none"
            })
        })

        // Filtro paquete
        const paqueteSelect = document.querySelector("[data-filter-paquete]")
        const paquetes = document.querySelectorAll("[data-paquete]")

        paqueteSelect.addEventListener("change", e => {
            const val = e.target.value
            paquetes.forEach(p => {
                p.style.display = !val || p.dataset.paquete === val
                    ? ""
                    : "none"
            })
        })
    })
</script>